<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:composite="http://java.sun.com/jsf/composite"
      xmlns:c="http://java.sun.com/jsp/jstl/core"
      >

    <composite:interface>
        <composite:attribute name="id" required="true" shortDescription="ID do InputText. Usado para referencia em outras partes do código." />
        <composite:attribute name="form" required="true" shortDescription="Formulário a ser atualizado." />
        <composite:attribute name="mbView" type="br.com.onesystem.war.service.impl.BasicMBReportImpl" required="true" shortDescription="Nome do managedBean da view" />
    </composite:interface>

    <composite:implementation>

        <f:loadBundle basename="label_messages" var="l"/>


        <p:panelGrid columns="2" style="width: 50%" layout="grid" columnClasses="ui-g-12 ui-md-6 ui-lg-2,ui-g-12 ui-md-6 ui-lg-10 ui-fluid" styleClass="ui-panelgrid-blank form-group form-elements">
            <p:outputLabel value="#{l.Filtrar_Por}:"/>
            <p:selectOneMenu id="camposParaFiltrar" value="#{cc.attrs.mbView.campoSelecionadoString}">
                <p:ajax listener="#{cc.attrs.mbView.filterField}" update="#{cc.attrs.form}" />
                <f:selectItem itemLabel="#{l.Selecione}" />
                <f:selectItems value="#{cc.attrs.mbView.campos.list}" var="fieldModel" itemValue="#{fieldModel.nome}" itemLabel="#{fieldModel.nome}" />
            </p:selectOneMenu>

            <p:outputLabel value="#{l.Tipo_de_Busca}:"/>
            <p:selectOneMenu id="tiposDeBusca" value="#{cc.attrs.mbView.tipoDeBuscaSelecionada}">
                <f:selectItems value="#{cc.attrs.mbView.tiposDeBusca}" var="tipoDeBusca" itemValue="#{tipoDeBusca}" itemLabel="#{tipoDeBusca.nome}" />
            </p:selectOneMenu>

            <p:outputLabel value="#{l.Consulta}:"/>
            <p:chips id="chipsFilter" value="#{cc.attrs.mbView.consulta}" 
                     rendered="#{!cc.attrs.mbView.date}" />
            <p:calendar id="dateFilter" pattern="dd/MM/yyyy" value="#{cc.attrs.mbView.consultaDate}" size="9" navigator="true" pages="3"
                        rendered="#{cc.attrs.mbView.date}" maskAutoClear="true" />

        </p:panelGrid>

        <p:panelGrid columns="2" style="width: 50%" layout="grid" columnClasses="ui-g-12 ui-md-6 ui-lg-2,ui-g-12 ui-md-6 ui-lg-10" styleClass="ui-panelgrid-blank form-group form-elements">
            <p:spacer/>
            <p:commandButton value="#{l.Pesquisar}" action="#{cc.attrs.mbView.pesquisar}" update="#{cc.attrs.form}" />
        </p:panelGrid>

        <p:panelGrid columns="2" style="width: 50%" layout="grid" columnClasses="ui-g-12 ui-md-6 ui-lg-2,ui-g-12 ui-md-6 ui-lg-10 ui-fluid" styleClass="ui-panelgrid-blank form-group form-elements">
            <p:spacer/>
            <p:column>
                <c:forEach var="filterModel" items="#{cc.attrs.mbView.filtros}" >

                    <ul class="ui-chips-container">
                        <p:outputLabel value="#{filterModel.field.nome} - #{filterModel.typeSearch.nome}  " /> 
                        <li class="ui-chips-token ui-state-active ui-corner-all" style="margin-top: -1px">
                            <span class="ui-chips-token-label">#{filterModel.filterDate ne null ? filterModel.filterDateFormat : filterModel.filters}</span>
                            <p:commandLink action="#{cc.attrs.mbView.delFilter(filterModel)}" update="#{cc.attrs.form}">
                                <i class="ui-chips-token-icon ui-icon ui-icon-close" style="color: white;"/>
                            </p:commandLink>
                        </li>
                    </ul>

                </c:forEach>
            </p:column>
        </p:panelGrid>

        <p:dialog widgetVar="exibirCampos" width="900" height="800">

            <h:panelGrid columns="3" style="height: 95%">

                <p:dataTable id="campos" widgetVar="camposTable" var="m" value="#{cc.attrs.mbView.camposDisponiveis}" selectionMode="multiple" emptyMessage="#{l.Nao_Ha_Registros}" 
                             rowKey="#{m.id}" reflow="true" style="border: none" scrollable="true" scrollHeight="600" selection="#{cc.attrs.mbView.modelDisponivelSelecionado}">

                    <f:facet name="header" >
                        <div align="right">
                            <h:outputText value="#{l.Campos_Disponiveis}: " />
                            <p:inputText id="globalFilter" onkeyup="PF('camposTable').filter()" style="margin-right: 5px" placeholder="#{l.Pesquisar}"/>
                        </div>
                    </f:facet>

                    <p:column headerText="#{l.Nome}" sortBy="#{m.object.nome}" filterBy="#{m.object.nome}" footerText="#{l.Nome}" filterMatchMode="contains">
                        <h:outputText value="#{m.object.nome}"/>
                    </p:column>

                </p:dataTable>

                <p:panelGrid columns="1" layout="grid" styleClass="ui-panelgrid-blank form-group form-elements">

                    <p:commandButton icon="fa fa-angle-right" action="#{cc.attrs.mbView.adicionarParaCampoExibido()}" update="campos camposExibidos" onsuccess="PF('camposTable').filter(), PF('camposExibidosTable').filter()" />
                    <p:commandButton icon="fa fa-angle-double-right" action="#{cc.attrs.mbView.adicionarTodosParaCampoExibido()}" update="campos camposExibidos" onsuccess="PF('camposTable').filter(), PF('camposExibidosTable').filter()" />
                    <p:commandButton icon="fa fa-angle-left" action="#{cc.attrs.mbView.excluirDeCampoExibido()}" update="campos camposExibidos" onsuccess="PF('camposTable').filter(), PF('camposExibidosTable').filter()"/>
                    <p:commandButton icon="fa fa-angle-double-left" action="#{cc.attrs.mbView.excluirTodosDeCampoExibido()}" update="campos camposExibidos" onsuccess="PF('camposTable').filter(), PF('camposExibidosTable').filter()" />

                </p:panelGrid>

                <p:dataTable id="camposExibidos" widgetVar="camposExibidosTable" var="m" value="#{cc.attrs.mbView.camposExibidos}" selectionMode="multiple" emptyMessage="#{l.Nao_Ha_Registros}"
                             rowKey="#{m.id}" reflow="true" style="border: none" scrollable="true" scrollHeight="600" draggableRows="true" editMode="cell" 
                             editable="true" selection="#{cc.attrs.mbView.modelExibidoSelecionado}">

                    <p:ajax event="rowReorder" listener="#{cc.attrs.mbView.onRowReorder}"/>

                    <f:facet name="header" >
                        <div align="right">
                            <h:outputText value="#{l.Campos_Exibidos}: " />
                            <p:inputText id="globalFilter" onkeyup="PF('camposExibidosTable').filter()" style="margin-right: 5px" placeholder="#{l.Pesquisar}"/>
                        </div>
                    </f:facet>

                    <p:column headerText="#{l.Nome}" sortBy="#{m.object.nome}" filterBy="#{m.object.nome}" footerText="#{l.Nome}" filterMatchMode="contains">
                        <h:outputText value="#{m.object.nome}"/>
                    </p:column>

                    <p:column headerText="#{l.Tamanho}" footerText="#{l.Tamanho}" style="text-align: center; width: 60px">
                        <p:cellEditor>
                            <f:facet name="output"><h:outputText value="#{m.object.tamanho}"/></f:facet>
                            <f:facet name="input">
                                <p:spinner value="#{m.object.tamanho}" min="0" style="text-align: center"/>
                            </f:facet>
                        </p:cellEditor>
                    </p:column>

                </p:dataTable>

            </h:panelGrid>

            <p:commandButton value="#{l.Confirmar}" update="objects" process="@parent" onclick="PF('exibirCampos').hide()"/>

        </p:dialog>


        <p:dataTable id="objects" widgetVar="objectsTable" var="object" value="#{cc.attrs.mbView.registros}" selectionMode="single" emptyMessage="#{l.Nao_Ha_Registros}"
                     rowKey="#{object.id}" reflow="true" style="border: none" >

            <f:facet name="header" >
                <div align="right">
                    <h:outputText value="#{l.Pesquisar_por_todos_campos}: " />
                    <p:inputText id="globalFilter" onkeyup="PF('objectsTable').filter()" style="width:150px; margin-right: 5px" placeholder="#{l.Pesquisar}"/>
                    <p:commandButton icon="fa fa-calculator" value="#{l.Exibir_Campos}" onclick="PF('exibirCampos').show()"/>
                    <h:commandLink>
                        <p:graphicImage name="/img/Excel.png" width="24" />
                        <p:dataExporter type="xls" target="objects" fileName="Registros" />
                    </h:commandLink>
                </div>
            </f:facet>

            <p:columns var="coluna" value="#{cc.attrs.mbView.camposExibidos.list}" 
                       filterBy="#{object ne null ? coluna.classeDeDeclaracao ne cc.attrs.mbView.clazz ? coluna.classeDeDeclaracao ne object.class ? !cc.attrs.mbView.mapPath.containsKey(coluna.classeDeDeclaracao) ? ' ' 
                                   : coluna.propriedadeDois eq null ? object[coluna.propriedade] : 
                                   coluna.propriedadeTres eq null ? object[coluna.propriedade][coluna.propriedadeDois] : 
                                   coluna.propriedadeQuatro eq null ? object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres] : 
                                   object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres][coluna.propriedadeQuatro] :  
                                   coluna.propriedadeDois eq null ? object[coluna.propriedade] : 
                                   coluna.propriedadeTres eq null ? object[coluna.propriedade][coluna.propriedadeDois] : 
                                   coluna.propriedadeQuatro eq null ? object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres] : 
                                   object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres][coluna.propriedadeQuatro] : 
                                   coluna.propriedadeDois eq null ? object[coluna.propriedade] : 
                                   coluna.propriedadeTres eq null ? object[coluna.propriedade][coluna.propriedadeDois] : 
                                   coluna.propriedadeQuatro eq null ? object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres] : 
                                   object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres][coluna.propriedadeQuatro] : ''}"
                       sortBy="#{coluna.propriedadeDois eq null ? object[coluna.propriedade] : 
                                 coluna.propriedadeTres eq null ? object[coluna.propriedade][coluna.propriedadeDois] : 
                                 coluna.propriedadeQuatro eq null ? object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres] : 
                                 object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres][coluna.propriedadeQuatro]}"
                       headerText="#{coluna.nome}" footerText="#{coluna.nome}" style="width: #{coluna.tamanhoFormatado}" 
                       >
                <h:outputText value="#{coluna.classeDeDeclaracao ne cc.attrs.mbView.clazz ? coluna.classeDeDeclaracao ne object.class ? !cc.attrs.mbView.mapPath.containsKey(coluna.classeDeDeclaracao) ? ' ' 
                                       : coluna.propriedadeDois eq null ? object[coluna.propriedade] : 
                                       coluna.propriedadeTres eq null ? object[coluna.propriedade][coluna.propriedadeDois] : 
                                       coluna.propriedadeQuatro eq null ? object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres] : 
                                       object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres][coluna.propriedadeQuatro] :  
                                       coluna.propriedadeDois eq null ? object[coluna.propriedade] : 
                                       coluna.propriedadeTres eq null ? object[coluna.propriedade][coluna.propriedadeDois] : 
                                       coluna.propriedadeQuatro eq null ? object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres] : 
                                       object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres][coluna.propriedadeQuatro] : 
                                       coluna.propriedadeDois eq null ? object[coluna.propriedade] : 
                                       coluna.propriedadeTres eq null ? object[coluna.propriedade][coluna.propriedadeDois] : 
                                       coluna.propriedadeQuatro eq null ? object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres] : 
                                       object[coluna.propriedade][coluna.propriedadeDois][coluna.propriedadeTres][coluna.propriedadeQuatro]}" />
            </p:columns>

        </p:dataTable>

    </composite:implementation>

</html>
